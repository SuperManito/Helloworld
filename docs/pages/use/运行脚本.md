# :fa-regular fa-display-code: 运行脚本
> 项目主要命令的使用与解读

## :fa-regular fa-signs-post: 导读

  - 请认真阅读所有内容，某些方法贯穿整个项目
  - 本项目CLI共有三个主命令，分别是 `task` `taskctl` `update`
  - 命令中用 `<xxx>` 括起来的部分表示需要用户自行输入相关内容
  - 命令帮助中的 `<args>` 表示固定可选的子命令，分别表示对应功能的不同用法

> 由于项目运行在容器内，所以不能直接在宿主机执行相关命令，可通过如下两种方式实现

- ### 执行命令的方式

  > [!NOTE|label:用户需知]
  > 需注意区分容器内、容器外这一基础概念性问题，容器外即表示宿主机，实际使用时应注意命令的执行位置

  - #### 在容器内执行

    ```bash
    docker exec -it jd bash
    ```
    > [!TIP]
    > 控制面板中的命令行界面就是在容器内操作的

  - #### 在宿主机执行

    ```bash
    docker exec -it jd bash <命令>
    ```
    > [!TIP|label:使用技巧]
    > 执行复杂命令需使用 `docker exec -it jd bash -c "<命令>"`，多个命令可以用 `;` 或 `&&` 连接即 `"<命令> && <命令>"`  
    > 后者 `&&` 表示前一条命令执行成功时，才执行后一条命令，相比前者用法较为特殊

- ### 查看命令帮助

  ```bash
  task
  ```
  > 即时查看项目内大部分CLI命令的使用方法，已针对不同架构的设备做了特殊处理

ㅤ

***

## :fa-solid fa-circle-play: 主要命令

- ### 普通执行

  ```bash
  task <name/path/url> now
  ```
  > `<name>` 表示脚本名（仅限scripts目录）;  `<path>` 表示相对路径或绝对路径;  `<url>` 表示脚本链接地址  
  > 脚本运行的日志存放在 **log** 目录下的文件夹内，文件夹名为`脚本名去后缀`，日志文件名主要由日期组成  
  > 扩展仓库脚本的日志文件夹名为`仓库名_脚本名去后缀`，并且中间用下划线分开

- ### 并发执行

  > 作用：为每个账号作为单独的进程同时在后台运行脚本，由于是后台运行故不在命令行输出进度直接记录到日志中

  ```bash
  task <name/path/url> conc
  ```

  > [!WARNING]
  > 并发执行非常消耗资源，不要盲目使用尤其是0点这种集中定时任务时段，否则机器资源占满导致连不上终端，可能只能操作强制关机重启


- ### 可选参数

  > [!NOTE|label:使用方法]
  > 追加在命令的末尾，熟练后可以使用简写，请认真阅读各参数的用法

  |          参数          |  作用   |    适用范围   | 详细描述 |
  | :-------------------: | :-----: | :----------: | :-----: |
  | `--loop` / `-l`       | 循环运行 | `普通`        | 连续多次运行脚本，参数后需跟`循环次数(正整数)`作为参数值，该参数与**等待执行**和**延迟执行**参数同时使用时仍然有效互不干涉 |
  | `--mute` / `-m`       | 静默运行 | `普通` `并发` | 静默运行任务不推送任何通知消息 |
  | `--wait` / `-w`       | 等待执行 | `普通` `并发` | 等待指定时间后再执行脚本，参数后需跟`等待时间单位`作为参数值，具体参照 [sleep](https://www.runoob.com/linux/linux-comm-sleep.html) 命令的用法 |
  | `--hang` / `-h`       | 后台挂起 | `普通`        | 将脚本设置为守护进程保持在后台运行，期间中断或结束会自动重新运行 |
  | `--agent` / `-a`      | 网络代理 | `普通` `并发` | 使脚本通过 HTTP/HTTPS 全局代理进行网络请求，仅支持 JavaScript 脚本，使用该功能需要自行在配置文件对应处定义代理地址变量 |
  | `--delay` / `-d`      | 延迟执行 | `普通` `并发` | 随机倒数一定秒数后再执行脚本，该秒数上限可以在配置文件中定义 |
  | `--proxy` / `-p`      | 下载代理 | `普通` `并发` | 仅适用于执行位于 GitHub 仓库的脚本，该代理固定为 [jsDelivr](https://www.jsdelivr.com/?docs=gh) 公共代理 |
  | `--rapid` / `-r`      | 迅速模式 | `普通` `并发` | 不组合互助码等步骤最大化降低脚本执行前耗时 |
  | `--cookie` / `-c`     | 指定账号 | `普通` `并发` | 参数后需跟`账号序号`作为参数值，多个账号用`,`隔开，账号区间用`-`连接，可以用`%`表示账号总数 |
  | `--grouping` / `-g`   | 账号分组 | `普通`        | 使每组账号单独运行脚本，参数后需跟`账号序号并分组`作为参数值，参数用法与 **指定账号** 相同，组与组之间用`@`隔开 |
  | `--background` / `-b` | 后台运行 | `普通`        | 不在前台输出脚本执行进度，不占用终端命令行 |

- ### 用法解读

  - #### 基础命令

    |    命令    |                              命令含义和使用范围                                   |
    | :-------: | :-----------------------------------------------------------------------------: |
    | `<name>`  |   脚本名，仅限 `scripts` 目录下的脚本，涵盖 `根目录` 以及 `utils` `backUp` 二个子目录 |
    | `<path>`  |   脚本的相对路径或绝对路径，支持用 `.` 或 `./` 表示当前目录和用 `../` 表示上一层目录    |
    | `<url>`   |   位于远程仓库的脚本链接地址，支持链接自动纠正功能，执行后脚本默认保存在 `scripts` 目录  |

    > [!NOTE|label:链接地址自动纠正是什么功能？]
    > 当拉取位于远程托管仓库的脚本时，无需刻意填写脚本文件的 raw 链接地址，可自动转换为原始文件链接以便于使用，此功能已应用到整个项目

  - #### 注意事项

    > 1. 执行以 `jd_` `jx_` `jr_` 为开头的脚本时该前缀内容可以省略，如遇同名则前者的优先级大于后者  
    > 2. 执行本地脚本时脚本名的后缀格式（脚本类型）可以省略，当未指定后缀格式时将启用模糊查找  
    > 3. 当未指定脚本类型但存在同名脚本时，执行优先级为 `JavaScript` > `Python` > `TypeScript` > `Shell`  
    > 4. 目前支持运行 `js` `py` `ts` `sh` 共四种类型的脚本，默认在容器启动时安装 Python 和 TypeScript 的运行环境

  - #### 关于指定账号相关参数的用法示例 <!-- {docsify-ignore} -->

    > [!WARNING|label:使用须知]
    > 在某些情况下**执行脚本频率**、**单账号运行频率**过高可能会造成严重 "后果" ，例如IP被限制、账号被拉黑

    - 指定第 **1** 和第 **5** 个账号执行脚本

      ```bash 
      task example.js now --cookie 1,5
      ```

    - 指定前 **10** 个账号执行脚本

      ```bash
      task example.js now --cookie 1-10
      ```

    - 指定第 **2** 至最后一个账号账号执行脚本

      ```bash
      task example.js now --cookie 2-%
      ```

    - 指定第 **1** 和第 **5** 个账号为一组、第 **2** 和第 **6** 个账号为一组执行脚本

      ```bash
      task example.js now --grouping 1,5@2,6
      ```

      > [!NOTE|label:账号分组的意义？]
      > 1. 有些脚本不能有效运行全部账号，一次只能运行单个或指定数量的账号
      > 2. 连续执行不能满足用户助力需求
      > 3. 减少出现由于执行频率过高所造成的影响

  - ##### 关于如何管理守护进程脚本

    - 查看有哪些守护进程正在运行

      ```bash
      pm2 list
      ```
      > 默认有三个项目服务 `web_server` `web_terminal` `jbot`

    - 停止运行

      ```bash
      pm2 delete <任务名>
      ```

ㅤ

***

## :fa-regular fa-balloon: 辅助命令

  - ### 终止执行

    ```bash
    task <name/path> pkill
    ```
    > 终止某个或某些正在运行中的脚本，根据脚本名称搜索对应的进程并立即杀死，当脚本报错死循环时建议使用此功能

  - ### 全部执行

    ```bash
    source runall
    ```
    > 通过 `交互` 选择运行模式执行指定范围的脚本，相当于批量执行脚本，时间较长不要盲目使用

  - ### 列出脚本

    ```bash
    task list
    ```
    > 查看本地有哪些可以运行的脚本

    - 列出指定路径下的脚本（扩展用法）
      > 可显示脚本修改时间和脚本文件大小

      ```bash
      task list <path>
      ```
      > `<path>` 支持用 `.` 或 `./` 表示当前目录和用 `../` 表示上一层目录
